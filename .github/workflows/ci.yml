
name: Build and Test ATROP

on:
  push:
    paths:
      - 'Makefile'
      - 'daemon/**'
      - 'sdk/**'
      - 'test/**'
      - 'dev-requirements.txt'
      - '.github/workflows/ci.yml'
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v3

    - name: ⚙️ Install system dependencies
      run: |
        sudo apt update && sudo apt install -y \
          build-essential \
          cmake \
          g++ \
          make \
          protobuf-compiler \
          protobuf-compiler-grpc \
          libgtest-dev \
          python3-pip

    - name: 🐍 Install Python dependencies
      run: |
        pip install -r dev-requirements.txt

    - name: 🐍 Install SDK in editable mode
      run: pip install -e ./sdk/python

    - name: 🔍 Print Python sys.path and import check
      run: |
        export PYTHONPATH=$(pwd)/sdk/python
        echo "Python Path:"
        python -c "import sys; print('\n'.join(sys.path))"
        python -c "import atrop_sdk; print('✅ SDK Import Successful:', atrop_sdk)"

    - name: 🔍 Check tool versions (optional)
      run: make check-versions

    - name: 🛠 Build daemon and SDK
      run: make

    - name: 🧪 Run Python unit tests
      run: |
        export PYTHONPATH=$(pwd)/sdk/python
        make test-python

    - name: 🔌 Generate gRPC stubs
      run: make generate-grpc-stubs

    - name: 📁 Inspect Build Output
      run: |
        file build/* || true
        ls -R sdk/grpc/build_py || true
        ls -R sdk/grpc/build_cpp || true

  docker-lint:
    name: 🐳 Dockerfile Lint & Build Check
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v3

    - name: 🧪 Debug check for .hadolint.yaml
      run: |
        echo "Listing root files:"
        ls -la .
        echo "Printing .hadolint.yaml:"
        cat .hadolint.yaml || echo "⚠️ Not found"

    - name: 🔍 Lint Dockerfile with hadolint + config
      run: docker run --rm -i -v "$PWD:/mnt" hadolint/hadolint < Dockerfile --config /mnt/.hadolint.yaml

    - name: 🛠 Test Docker Build
      run: docker build -t atrop-dev .
