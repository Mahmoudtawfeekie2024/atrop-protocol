
name: Build and Test ATROP

on:
  push:
    paths:
      - 'Makefile'
      - 'daemon/**'
      - 'sdk/**'
      - 'test/**'
      - 'dev-requirements.txt'
      - '.github/workflows/ci.yml'
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3

    - name: âš™ï¸ Install system dependencies
      run: |
        sudo apt update && sudo apt install -y \
          build-essential \
          cmake \
          g++ \
          make \
          protobuf-compiler \
          protobuf-compiler-grpc \
          libgtest-dev \
          python3-pip

    - name: ğŸ Install Python dependencies
      run: |
        pip install -r dev-requirements.txt

    - name: ğŸ Install SDK in editable mode
      run: pip install -e ./sdk/python

    - name: ğŸ” Print Python sys.path and import check
      run: |
        export PYTHONPATH=$(pwd)/sdk/python
        echo "Python Path:"
        python -c "import sys; print('\n'.join(sys.path))"
        python -c "import atrop_sdk; print('âœ… SDK Import Successful:', atrop_sdk)"

    - name: ğŸ” Check tool versions (optional)
      run: make check-versions

    - name: ğŸ›  Build daemon and SDK
      run: make

    - name: ğŸ§ª Run Python unit tests
      run: |
        export PYTHONPATH=$(pwd)/sdk/python
        make test-python

    - name: ğŸ”Œ Generate gRPC stubs
      run: make generate-grpc-stubs

    - name: ğŸ“ Inspect Build Output
      run: |
        file build/* || true
        ls -R sdk/grpc/build_py || true
        ls -R sdk/grpc/build_cpp || true

  python-lint:
    name: ğŸ§¼ Python Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
  
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
  
      - name: Install ruff
        run: pip install ruff
  
      - name: Run ruff on all Python dirs
        run: |
          ruff check daemon/
          ruff check sdk/
          ruff check tools/
          ruff check test/
          ruff check models/

  cpp-lint:
    name: ğŸ§¼ C++ Lint (clang-tidy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
  
      - name: Install clang-tidy
        run: sudo apt update && sudo apt install -y clang-tidy
  
      - name: Run clang-tidy on daemon/control_plane
        run: |
          find daemon/control_plane -name '*.cpp' -print0 | xargs -0 -n1 clang-tidy --quiet || true
  
      - name: Run clang-tidy on daemon/ipc
        run: |
          find daemon/ipc -name '*.cpp' -print0 | xargs -0 -n1 clang-tidy --quiet || true


  docker-lint:
    name: ğŸ³ Dockerfile Lint & Build Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3

    - name: ğŸ§ª Debug check for .hadolint.yaml
      run: |
        echo "Listing root files:"
        ls -la .
        echo "Printing .hadolint.yaml:"
        cat .hadolint.yaml || echo "âš ï¸ Not found"

    - name: ğŸ” Lint Dockerfile with hadolint + config
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/mnt" \
          hadolint/hadolint \
          hadolint /mnt/Dockerfile --config /mnt/.hadolint.yaml --no-fail


    - name: ğŸ›  Test Docker Build
      run: docker build -t atrop-dev .

  python-test:
    name: ğŸ§ª Python Unit Tests
    runs-on: ubuntu-latest
    steps:

      - name: Run pytest on unit tests
        run: |
          export PYTHONPATH=$PYTHONPATH:./sdk/python/src
          pytest test/unit/ --maxfail=5 --disable-warnings --tb=short

      - name: Checkout Repo
        uses: actions/checkout@v3
  
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
  
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
  
      - name: Run pytest on unit tests
        run: |
          pytest test/unit/ --maxfail=5 --disable-warnings --tb=short
